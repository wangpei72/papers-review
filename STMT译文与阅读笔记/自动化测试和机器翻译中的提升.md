# 自动化测试和机器翻译中的提升

## 摘要

本文介绍了TransRepair，这是一种用于测试和修复机器==翻译系统一致性==的==全自动==方法。 TransRepair将变形与变形测试结合起来，以检测不一致的错误（无需访问人类甲骨文）。然后，它采用概率参考或交叉参考以灰盒或黑盒的方式对翻译进行后处理，以修复不一致之处。我们对两个最先进的翻译器Google Translate和Transformer的评估表明，TransRepair在生成具有一致翻译的输入对时具有很高的精度（99％）。通过这些测试，使用自动一致性指标和手动评估，我们发现Google Translate和Transformer大约有36％和40％的不一致错误。黑匣修复程序可平均修复Google Translate和Transformer的28％和19％的错误。灰盒修复程序可以平均修复30％的Bug。人工检查表明，通过我们的方法修复的译文在87％的案例中提高了一致性（降级约2％），并且在27％的案例中我们的修复具有更好的翻译可接受性（差的情况是8％）。

## 关键词

机器翻译，测试和修复，翻译一致性

## 简介

机器学习已经成功地提供了通用的自然语言翻译系统，其中许多系统能够实时有效地在数千对语言之间进行翻译[20]。 然而，这样的翻译系统并不完美，用户遇到的错误与传统的基于非机器学习的软件系统上的错误具有不同的特征[3，25，26，50]。

长期以来，人们一直对误译的后果进行研究，结果表明后果很严重。 例如，据报道，《 Uccialli条约》第十七条的历史性误译导致了战争[12]。 据报道，误译的这种真正深刻和深远的后果也正成为国际紧张局势和冲突的严重和有力根源[29]。

通过基于机器的翻译程序进行错误翻译的后果也很严重。 例如，机器翻译已显示出有害的公平错误，严重损害了特定的用户群体[31]。 我们已经在广泛使用的工业强度转换系统中发现了这样的示例。 图1显示了几种针对该语言对（英语→中文）的Google翻译结果。 从图中可以看出，当主题为“男人”或“男学生”时，Google翻译会将“好”翻译为“非常好”。 但是，有趣的是，但令人遗憾的是，当主题是“妇女”或“女学生” 时，它会将“好”翻译成“很多”（意思是“很多”）。

这种不一致可能会使用户感到困惑，并且显然对计算机科学领域的女性研究人员不公平； 与进行“非常好的”研究相比，进行“大量”的研究显然是一种贬义的解释。 为了避免这种不公平的翻译（大规模），我们需要能够自动识别和纠正此类不一致之处的技术。

为了解决这个问题，我们引入了一种组合的测试和修复方法，该方法可以自动为实际的机器翻译系统生成测试，并自动修复在测试阶段发现的错误翻译。 正如我们在本文中所展示的，我们需要重新考虑测试和修复的常规方法，以便将其应用于自然语言翻译。

现有的工作已经测试了机器翻译系统是否为语义相等的转换提供稳定的翻译，例如同义词替换（例如，purchase→buy）[6]或缩写替换（例如，what’s→what is）[33]。 但是，以前没有工作集中在上下文相似的转换翻译表现出的不一致性的测试和修复上。 具有相似词嵌入的句子之间的转换[13]却在语料库中共享上下文（例如，简单的基于性别的转换，例如男孩→女孩）。

为了解决测试问题，我们引入了一种结合突变[23]和变态测试[4，48]的方法。 该方法进行上下文相似的变异以生成变异的句子，这些句子可用作被测试翻译者的测试输入。 当上下文相似的突变对未突变部分的翻译产生高于阈值的中断时，该方法将报告不一致错误。

传统的“修复”机器学习系统方法通常使用数据增强或算法优化。 这些方法的最佳特征是“提高”机器学习器的整体效率，而不是针对单个错误进行特定的修复。 他们还需要数据收集/标记和模型再培训，而这通常成本很高。

传统的“修复”软件错误的方法是白盒，因为这些技术需要识别需要修改的源代码行才能实施修复程序。 这样的方法固有地不能应用于修复源代码不可用的软件，例如第三方代码。

我们的见解是，通过结合系统重复输出（可能不一致）的结果，我们可以实现轻量级的黑箱修复技术，作为针对特定错误的“后处理”阶段。 我们的方法是第一种以纯黑盒方式修复系统的修复技术。 我们相信，除了机器翻译修复的特定应用之外，黑盒修复还具有可观的潜在收益。 当软件工程师在没有源代码的系统中遇到错误时，这是唯一可用的方法。

我们不仅证明黑盒修复是可行的，而且可以扩展到现实世界中具有工业实力的翻译系统，例如Google Translate。 我们还介绍了灰盒修复的结果，对于该结果，可以提供预测概率。

TransRepair是在两个最先进的机器翻译系统Google Translate和Transformer [42]上进行评估的。 特别是，我们专注于两种最广泛使用的语言：英语和中文之间的翻译。 这些语言在全球拥有超过十亿的使用者[9]。 然而，中国只有1000万人（不到人口的1％）能够通过英语交流[43，44]。 由于很少有人会说两种语言，因此机器翻译通常很有吸引力，有时是必需的和不可避免的。

我们的结果表明，

- TransRepair有效地生成有效的测试输入，精度为99％；
-  2）TransRepair会根据学习到的阈值自动有效地报告不一致错误，对于Google Translate / Transformer，F平均值为0.82 / 0.88；
-  3）Google Translate和Transformer都有不一致的错误。 自动化的一致性指标和手动检查表明，Google Translate在我们生成的测试输入中存在大约36％的不一致翻译。
-  4）黑盒修复可减少28％和19％的Google Translate和Transformer错误。 灰色盒子减少了30％的Transformer错误。 手工检查表明，修复后的译文在87％的案例中提高了一致性（仅2％降低了一致性），在27％的案例中具有更好的翻译接受性3（仅8％）。

## 方法

### 概览

图2给出了TransRepair的高级视图。从该图可以看出，TransRepair基于以下三个主要步骤自动测试并修复了机器翻译的不一致性：

1. 自动测试输入生成步骤：
   此步骤生成转换后的句子（测试输入）以用于一致性测试。 对于每个句子，TransRepair通过上下文相似的单词替换进行句子变异。 使用语法检查过滤生成的突变候选句子。 然后，通过语法检查的突变句子将被视为接受测试的机器翻译程序的最终测试输入。 详情见第2.2节。

2. 自动测试预估生成步骤：
   此步骤介绍了oracle的生成，这些oracle用于标识不一致的翻译（错误）。 在这一步中，我们依赖于翻译输入和翻译输出之间的变形关系。 想法是，原始句子及其上下文相似的突变体的翻译输出应具有一定程度的一致性，以变异词为模。 我们使用相似性度量标准来度量翻译的输出之间的一致性程度，作为测试预估。 第2.3节介绍了此步骤的详细信息。 我们探索了四个相似性度量，这在第3.2节中有描述。

3. 自动不一致性修复：

   此步骤将自动修复不一致的翻译。 TransRepair应用黑盒法和灰盒法，它们基于突变句子中的最佳翻译来转换原始翻译。 我们探讨了选择最佳翻译的两种方法，一种是使用预测概率，另一种是使用交叉引用。 该步骤的详细信息在第2.4节中给出。

### 自动测试输入生成

#### 上下文相似语料库构建

#### 翻译输入变体生成

### 自动测试预估生成步骤

为了执行测试，我们需要增加使用测试oracle生成的测试输入，即谓词，用于检查是否已发现不一致错误。 为此，我们假设句子的未更改部分保留了对变异词取模的适当性和流畅性。 适当性是指翻译是否传达相同的意思，是否存在信息丢失，增加或失真的情况； 流利度表示输出是否流利且语法正确[8，16]。

==TODO==

### 自动不一致性修复

#### 总体过程

#### 基于概率的翻译排名

#### 基于交叉引用的翻译排名

## 实验装置

### 研究问题

我们通过评估TransRepair生成可用于一致性测试的有效且一致的测试输入的能力来开始我们的研究。 因此，我们问：

#### TransRepair的测试输入有多准确？ 

#### TransRepair的翻译问题揭示功能怎样体现？

#### TransRepair的翻译问题修复功能怎样体现？

### 一致性指标

我们探索了四个广泛采用的相似性度量标准来度量不一致。 为了便于说明，我们使用t1表示原始翻译输入的翻译输出； 我们用t2表示突变翻译输入的翻译输出。

#### LCS指标

#### ED指标

#### tf-idf指标

#### BLEU指标

### 机器翻译器

我们使用默认设置来训练Transformer。 基于三个数据集对Transformer进行训练：具有7,086,820个并行句子的CWMT数据集[7]，具有15,886,041个并行句子的UN数据集[53]和具有252,777个并行句子的新闻评论数据集[46]。 验证数据（以帮助调整超参数）也来自新闻评论，并包含2,002个并行句子。 Transformer与Tensor2Tensor深度学习库一起运行[41]。 为了获得更有效的翻译，我们将模型训练了500,000轮。

### 测试集

继先前的机器翻译研究[18，19]之后，我们将新闻评论[46]数据集中的测试集用于Google Translate和Transformer。 测试集包含2,001个并行句子，与训练集和验证集不同。 我们实验中的中文句子是字符集合形式的。

## 结果

### 输入生成的效率

我们首先回答RQ1。 对于每个测试语句，我们都会生成突变体并检查它们是否通过了结构过滤（请参阅第2.2.2节中的更多内容）。 特别是，对于每个句子，我们最多生成5个通过过滤器的突变体（我们在第5节中研究了突变体数量的影响）。 对于2,001个测试语句，生成了21,960个候选突变，通过结构过滤丢弃了17,268个。 在我们的其余实验中，我们将剩余的4,692个突变体（与1,323个句子配对）用作测试输入。

为了手动评估这些测试输入是否符合检测翻译不一致的条件，我们随机抽取了400个样本。 前两位作者手动检查了输入的有效性，即，突变体中被替换的单词是否导致语法错误，以及突变体是否应与原始句子保持一致的翻译。 这个验证步骤揭示了三个无效的突变体：1）他是一个善良的人，胸怀宽广：善良→善良； 2）两次地震分别为4.4级和4.5级：两次→六级； 3）这本身就是一个很大的耻辱：很好→很好。

400个中的其余397个满足两个有效标准，即达到99％的精度。 我们得出的结论是，两个word2vec模型的相交的两种策略以及使用Stanford Parser作为过滤器都有很大的可能性产生有效的测试词。 可在TransRepair主页上找到400个突变体和手动评估结果[2]。

在下一节中，我们将使用4,692个变体（来自1,323个原始句子）来检查机器翻译系统的测试翻译一致性。

对RQ1的回答：TransRepair具有很高的精度（99％），可以生成语法正确的测试句子并产生一致的翻译。

### 不一致性揭露的能力

本部分回答RQ2，即研究TransRepair的不一致显示能力。 为了回答这个问题，我们研究：

- 1）突变体和原始翻译之间的一致性度量值； 
- 2）人工检查翻译结果不一致的地方。 我们还将探讨一致性度量标准和手动检查在评估不一致性方面的接近程度。

==。。。==

图3显示了一致性得分的直方图，该得分低于1.0。 从图中可以看出，不同的指标值具有不同的分布，但总体而言，所有四个指标报告的翻译数量很多（即，占翻译总数的47％），且评分低于1.0，表明存在翻译不一致。

表1显示了报告的具有不同度量阈值的不一致翻译的结果。 从表1中可以看出，即使对于高度允许的一致性阈值，错误仍然存在。

垂直虚线左侧/右侧的点表示手动标记为一致/不一致的翻译的度量值。 我们注意到，左侧部分的大多数点（82.2％）的得分为1.0。 左部分的得分值（平均值为0.99）通常比右部分（平均值为0.86）高。 这些观察结果表明，度量值和手动检查倾向于就翻译不一致达成一致。 值得注意的是，图4在左侧部分还显示了一些较低的度量值，在右侧部分中显示了较高的度量值，这表明存在使用度量标准评估一致性的+误报和-误报。 我们将在下面更详细地分析正向误报和负向误报：



==。。。==

在对FP和FN进行手动检查之后，我们发现，当字符差异较小但含义或语调不同时，可能会发生FN。 例如，在我们的结果中，一个突变翻译有一个额外的er（意思是“但是”），它在原始翻译中不存在。 手动检查认为这是不一致的，而度量标准却没有。 两种翻译中有许多不同的单词，但它们具有相同的含义时，可能会发生FP。 例如，中文短语shang wei和hai mei都表示“还没有”，但是表示每个短语的字符却完全不同。

FP在测试过程中可能带来的危害在于我们的方法可能会使翻译变得更糟。 第4.3.2节探讨了这种可能性。

**对RQ2的回答：当检测到Google Translate / Transformer的不一致错误时，这些指标的F度量为0.82 / 0.88。 指标和手动检查都表明，Google Translate在TransRepair测试输入中的翻译不一致约36％。**

### 误译修复能力

从表中可以看出，TransRepair可以平均减少28％的Google Translate黑盒方法错误。 对于Transformer模型，我们可以看到灰盒方法可修复30％的错误，黑盒方法可修复19％至20％的错误。 这些实验结果表明，灰盒法和黑盒法可以有效地修复不一致的错误。



==。。。==

我们发现TransRepair在改善翻译一致性方面具有良好的效果。 例如，平均而言，87％的翻译对提高了Google翻译和翻译的一致性，而我们在一起观察到的翻译一致性仅降低了3个。 我们检查了这些降低一致性的修复，发现在一种情况下，原始句子翻译得到了改进，而对于突变翻译则没有，因此，在修复后，原始句子的改进翻译与未经改进的突变体翻译不完全匹配。 剩下的两个案例的出现是因为原始句的修复减少了，而我们的方法没有涉及突变体的翻译。

我们的修复方法的主要目的是提高翻译的一致性。 提高翻译可接受性是我们方法的“奖励”。 从表4中，也许使我们惊讶的是，修复方法提高了大约四分之一（27％）修复的翻译可接受性。 8％的维修会降低可接受性。 根据我们的人工检查，可接受性降低的原因是，维修方法有时可能会为了保持一致性而牺牲质量。

**RQ3的答案：黑盒修复程序可平均减少28％/ 19％的Google Translate / Transformer错误。 灰盒修复平均可减少Transformer 30％的错误。 人工检查表明，修复后的译文在87％的案例中提高了一致性（减少了2％），并且在27％的案例中具有更好的译文接受性（更糟的是8％）。**

## 扩展分析与探讨

### transrepair的效率

TransRepair的成本包括测试和维修。 在我们当前的实验配置下（请参见第3节中的更多详细信息），平均测试时间为每句0.97秒； 对于基于概率的方法，平均修复时间为每句2.68s，对于基于交叉引用的方法，平均修复时间为每句2.93s。 因此，在当前的实验配置下，当使用TransRepair优化实时在线机器翻译时，对于被认为非笨拙的句子，最终用户将花费不到1秒的时间来接收最终翻译。 对于被认为是有问题的句子，只需不到4秒钟（测试和修复）即可获得最终翻译。





